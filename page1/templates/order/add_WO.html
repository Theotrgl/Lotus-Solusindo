{% extends 'base.html' %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    {% block title %}Add Work Order{% endblock %}
</head>

<body>
    {% block content %}
    <h2>Add Work Order</h2>
    <div class="form-group w-50">
      <form method="post" class="mt-3">
        {% csrf_token %}
        <div class="form-group">
          {{entity_form.customer.label_tag}}
          {{entity_form.customer}}
          {% for error in entity_form.customer.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
          <!-- <a href="/add_customer">Add</a> -->
        </div>
        <div class="form-group">
          {{entity_form.item.label_tag}}
          {{entity_form.item}}
          {% for error in entity_form.item.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
          <!-- <a href="/add_item">Add</a> -->
        </div>
        <div class="form-group">
          {{entity_form.revenue_PO.label_tag}}
          {{entity_form.revenue_PO}}
          {% for error in entity_form.revenue_PO.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <div class="form-group">
          {{entity_form.nomor_PO.label_tag}}
          {{entity_form.nomor_PO}}
          {% for error in entity_form.nomor_PO.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <div class="form-group">
          {{entity_form.tanggal_PO.label_tag}}
          {{entity_form.tanggal_PO}}
          {% for error in entity_form.tanggal_PO.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <div class="form-group">
          {{entity_form.tanggal_process.label_tag}}
          {{entity_form.tanggal_process}}
          {% for error in entity_form.tanggal_process.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <div class="form-group">
          {{entity_form.tanggal_input_accurate.label_tag}}
          {{entity_form.tanggal_input_accurate}}
          {% for error in entity_form.tanggal_input_accurate.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <div class="form-group">
          {{entity_form.tanggal_pengiriman_barang.label_tag}}
          {{entity_form.tanggal_pengiriman_barang}}
          {% for error in entity_form.tanggal_pengiriman_barang.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <div class="form-group">
          {{entity_form.tanggal_pengiriman_invoice.label_tag}}
          {{entity_form.tanggal_pengiriman_invoice}}
          {% for error in entity_form.tanggal_pengiriman_invoice.errors %}
          <p class="text-danger">{{error}}</p>
          {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
          console.log("Script Loaded");
  
          $("#id_customer").change(function () {
              console.log("Customer changed");
              var customerId = $(this).val();
              // console.log("Customer ID:", customerId);
              
              if (customerId !== "") {
                  $.ajax({
                      url: "{% url 'get_customer_item' %}",
                      data: {
                          customer_id: customerId,
                      },
                      dataType: "json",
                      success: function (data) {
                          console.log("AJAX Success:", data);
                          $("#id_item").empty(); // Clear pic dropdown
                          $.each(data, function (index, item) {
                              $("#id_item").append(
                                  '<option value="' + item.SKU + '">' + item.nama + "</option>"
                              );
                          });
                          updateRevenue()
                      },
                      error: function(xhr, status, error) {
                          console.log("AJAX Error:", error);
                      }
                  });
              }
          });

          $("#id_item").change(function () {
            updateRevenue(); // Update revenue on item change
          });


          function updateRevenue() {
            var selectedItemId = $("#id_item").val();

            // Assuming 'itemData' contains the details of the selected item including its price
            // You might need to adjust this part based on your data structure
            var itemData = {
                SKU: selectedItemId, // Assuming SKU is used to identify the item
                price: 0, // Default price in case data does not provide it
            };

            // Here, you can use the selectedItemId to fetch the price of the item via another AJAX call
            // This is a placeholder to demonstrate the approach
            $.ajax({
                url: "{% url 'get_item_details' %}", // Adjust URL for fetching item details
                data: { item_id: selectedItemId },
                dataType: "json",
                success: function (itemDetails) {
                    var priceString = itemDetails.price;
                    var numericPrice = parseFloat(priceString.replace(/[^\d.-]/g, ''));
                    var priceCurrency = itemDetails.price_currency
                    // console.log("Numeric Price:", numericPrice);
                    // console.log(itemDetails.price_currency)

                    // Update the revenue element with the item price
                    $("#id_revenue_PO_0").val(numericPrice);
                    $("#id_revenue_PO_1").val(priceCurrency);
                },
                error: function(xhr, status, error) {
                    console.log("Error fetching item details:", error);
                }
            });
          }
        });
    </script>
    {% endblock %}
</body>

</html>